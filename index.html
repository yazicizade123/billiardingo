<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-Cushion Bilardo Oyunu</title>
    <!-- Tailwind CSS CDN for responsive and modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the game to ensure full screen mobile experience */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            overflow: hidden; /* Prevent scrolling on mobile */
        }

        /* Game Container: Flexible to fit the vertical canvas */
        #gameContainer {
            width: 100vw;
            height: 100vh;
            max-width: 900px; 
            max-height: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Canvas for the Billiards Table */
        #billiardsCanvas {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            border: 10px solid #333; /* Rail/Frame color */
            border-radius: 8px;
            touch-action: none; /* Crucial for better touch input on table */
            max-width: 90%; 
            max-height: 90%;
            background-color: #034827; /* Green cloth */
            margin-right: 60px; /* Güç çubuğu için sağda boşluk bırak */
        }
        
        @media (min-width: 640px) {
            /* Masa üstü cihazlarda daha fazla boşluk */
            #billiardsCanvas {
                 margin-right: 120px; 
            }
        }


        /* General styles for buttons */
        .game-button {
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            background-color: #4f46e5;
            color: white;
            border: none;
            margin: 8px;
            font-size: 1.1rem;
        }

        .game-button:hover, .game-button:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        }

        /* Dikey Güç İstekası (Power Bar) Stili */
        #powerBarContainer {
            position: absolute;
            right: 4px; /* Masa kenarına yakın */
            top: 15%; 
            width: 60px; 
            height: 350px; 
            background-color: #2D3748; /* Koyu Gri Zemin */
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            border: 2px solid #aaa; 
            z-index: 100;
            display: none; 
            cursor: pointer; 
            touch-action: none; 
            padding: 10px 0; 
            box-sizing: border-box; 
        }
        
        @media (min-width: 640px) {
            #powerBarContainer {
                right: 40px; 
            }
        }

        /* Güç Barı Dolumu */
        #powerBarFill {
            width: 100%;
            height: 0%; 
            background-color: #ef4444; 
            position: absolute;
            bottom: 0; 
            transition: height 0.05s ease-out, background-color 0.2s;
            border-radius: 0 0 8px 8px;
            z-index: 100; 
        }

        /* İsteka Handle: Artık görsel hareketi bu taşıyor */
        #cueHandle {
            position: absolute;
            top: 10px; /* Üst padding'den başla */
            left: 0;
            width: 100%;
            height: calc(100% - 20px); /* Konteyner yüksekliği - 2 * padding */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* İsteka başlangıçta en üstte dursun */
            touch-action: none; 
            z-index: 101; 
            pointer-events: none; /* Sadece powerBarContainer'ı dinleyeceğiz */
            transition: transform 0.05s ease-out; /* Hızlı hareket için */
            transform: translateY(0px); /* Başlangıç konumu */
        }

        #cueHandle svg {
            /* Dikey İsteka SVG boyutu */
            height: 100%; /* Konteyneri kapla */
            width: 8px;
            filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.8));
        }
        
        /* English Selector area repositioned to be under the power bar */
        #englishSelector {
            position: absolute;
            right: 0px; 
            top: calc(15% + 350px + 20px); 
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 2px solid #aaa;
            cursor: pointer;
            z-index: 100;
            display: none; 
        }

        @media (min-width: 640px) {
            #englishSelector {
                right: 30px; 
            }
        }
        
    </style>
</head>
<body>

<div id="gameContainer" class="p-4 sm:p-8">
    <!-- Game Canvas -->
    <canvas id="billiardsCanvas"></canvas>

    <!-- Main Menu / Screen Container -->
    <div id="screenContainer" class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-95 z-20">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <!-- Pause Button (always visible during gameplay) -->
    <button id="pauseButton" class="game-button absolute top-4 right-4 text-sm px-3 py-2 z-10 hidden">DURAKLAT</button>

    <!-- Dikey Güç İstekası (Power Bar) -->
    <div id="powerBarContainer">
        <!-- Güç dolumu alttan yukarı dolsun diye fill altta -->
        <div id="powerBarFill"></div>
        
        <!-- İsteka Handle (Görsel ve Sürükleme Alanı) -->
        <div id="cueHandle">
            <!-- Dikey İsteka SVG İkonu -->
            <svg viewBox="0 0 8 330" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- İsteka Gövdesi (Uzun ve Kahverengi) -->
                <rect x="0" y="0" width="8" height="330" rx="4" fill="#A0522D"/> 
                <!-- İsteka Ucu (Tip - En üstte) -->
                <circle cx="4" cy="4" r="3" fill="#FFE4B5"/> 
                <!-- Kuyruk Topuzu (En altta) -->
                <circle cx="4" cy="326" r="4" fill="#333333"/> 
            </svg>
        </div>
    </div>
    
    <!-- English/Spin Selection Area (Power bar'ın altına taşındı) -->
    <div id="englishSelector">
        <canvas id="englishCanvas" width="80" height="80"></canvas>
    </div>

</div>

<script>
    // Sabitler (DİKEY MASA VE BÜYÜK TOPLAR İÇİN GÜNCELLENDİ)
    const CANVAS_WIDTH = 400;  // Dikey masa genişliği
    const CANVAS_HEIGHT = 800; // Dikey masa yüksekliği
    const BALL_RADIUS = 20;    // Top boyutu
    const CUSHION_WIDTH = 10; 
    const FRICTION = 0.99; 
    const SPIN_FACTOR = 0.005; 
    const MIN_VELOCITY = 0.1; 
    const MAX_SHOT_POWER = 15;
    
    // YENİ HASSASİYET AYARI (Gereken çekme mesafesi artırıldı)
    const POWER_DRAG_SENSITIVITY = 500; // Maksimum güce ulaşmak için ekranda çekilmesi gereken piksel mesafesi. Bu değer ne kadar büyükse, hassasiyet o kadar artar.
    
    const CUE_BALL_COLOR = '#FFFFFF';
    const OBJECT_BALL_COLOR = '#FF0000'; // Kırmızı
    const OBJECT_BALL_2_COLOR = '#FFFF00'; // Sarı
    const TEXT_COLOR = '#E5E7EB';

    // --- OYUN VERİLERİ (LEVELS ve SHOPITEMS) ---
    
    // Level Konumları (Beyaz, Kırmızı, Sarı)
    const levels = [
        // Level 1: Basic setup for 3-cushion (Easy)
        {
            white: { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT * 0.8 },
            red: { x: CANVAS_WIDTH * 0.3, y: CANVAS_HEIGHT * 0.25 },
            yellow: { x: CANVAS_WIDTH * 0.7, y: CANVAS_HEIGHT * 0.45 }
        },
        // Level 2: Slightly more challenging
        {
            white: { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT * 0.75 },
            red: { x: CANVAS_WIDTH * 0.25, y: CANVAS_HEIGHT * 0.35 },
            yellow: { x: CANVAS_WIDTH * 0.6, y: CANVAS_HEIGHT * 0.15 }
        },
        // Level 3: Corner shot focus
        {
            white: { x: CANVAS_WIDTH * 0.7, y: CANVAS_HEIGHT * 0.6 },
            red: { x: CANVAS_WIDTH * 0.8, y: CANVAS_HEIGHT * 0.15 },
            yellow: { x: CANVAS_WIDTH * 0.2, y: CANVAS_HEIGHT * 0.2 }
        }
    ];

    // Dükkan Öğeleri (İstekalar ve Toplar)
    const shopItems = {
        cues: [
            { name: "Standard Cue", powerMultiplier: 1.0, price: 0, description: "Standart isteka. Güçlü ve güvenilir." },
            { name: "Power Max Cue", powerMultiplier: 1.5, price: 1000, description: "Daha sert vuruşlar için ekstra güç." },
            { name: "Control Pro Cue", powerMultiplier: 1.1, price: 2500, description: "Hafif güç artışı, falsoda daha iyi kontrol." }
        ],
        balls: [
            { name: "Default", color: CUE_BALL_COLOR, price: 0, description: "Standart beyaz top." },
            { name: "Blue Marble", color: '#00BFFF', price: 500, description: "Mavi mermer efektli beyaz top." },
            { name: "Gold Dust", color: '#FFD700', price: 1500, description: "Altın tozu desenli lüks top." }
        ]
    };

    // Oyun Durum Değişkenleri
    let currentScreen = 'main_menu';
    let gameReady = false;
    let canvas, ctx;
    let englishCanvas, englishCtx;
    let powerBarContainer, cueHandle, powerBarFill;
    let balls = [];
    let level = 1;
    let shotAttempt = 1;

    // Nişan Alma Mekaniği Değişkenleri
    let isAiming = false; 
    let isDragging = false; 
    let aimTargetPos = { x: 0, y: 0 }; 
    let shotAngle = 0; 
    let shotPower = 0;
    
    // GÜÇ ÇUBUĞU VE HAREKET DEĞİŞKENLERİ
    let isSliderDragging = false; 
    let dragStartScreenY = 0; 
    let VISUAL_BAR_HEIGHT = 0; // Güç çubuğunun net görsel yüksekliği
    let cueHandleVisualY = 0; // İsteka görselinin pozisyonu (0'dan VISUAL_BAR_HEIGHT'a kadar)
    
    let englishX = 0; 
    let englishY = 0; 
    let isBallMoving = false;
    let hitTargets = { red: false, yellow: false, bands: 0 };
    let currentCue = { name: "Standard Cue", powerMultiplier: 1.0, price: 0 };
    
    const CUE_CONTAINER_PADDING = 10; 

    // Player Data (Managed by localStorage)
    let playerData = {
        coins: 0,
        currentLevel: 1,
        ownedCues: ["Standard Cue"],
        ownedBalls: ["Default"],
        selectedCue: "Standard Cue",
        selectedBall: "Default",
        sfx: true,
        music: true
    };

    const getUserId = () => 'local_user';

    // --- Persistence Functions (localStorage) ---

    function loadGameData() {
        const data = localStorage.getItem(`billiards_data_${getUserId()}`);
        if (data) {
            playerData = JSON.parse(data);
            level = playerData.currentLevel;
            currentCue = shopItems.cues.find(c => c.name === playerData.selectedCue) || shopItems.cues[0];
        }
        if (!playerData.ownedCues.includes("Standard Cue")) playerData.ownedCues.push("Standard Cue");
        if (!playerData.ownedBalls.includes("Default")) playerData.ownedBalls.push("Default");
    }

    function saveGameData() {
        localStorage.setItem(`billiards_data_${getUserId()}`, JSON.stringify(playerData));
    }

    // --- Ball Class (Top Sınıfı - Basitleştirilmiş) ---
    class Ball {
        // ... (Ball class içeriği aynı kaldı)
        constructor(x, y, color, type) {
            this.x = x;
            this.y = y;
            this.vx = 0;
            this.vy = 0;
            this.radius = BALL_RADIUS;
            this.color = color;
            this.type = type; // 'cue', 'red', 'yellow'
            this.mass = 1;
        }

        update() {
            if (this.isMoving()) {
                this.x += this.vx;
                this.y += this.vy;

                this.vx *= FRICTION;
                this.vy *= FRICTION;

                if (Math.hypot(this.vx, this.vy) < MIN_VELOCITY) {
                    this.vx = 0;
                    this.vy = 0;
                }

                this.checkCushionCollision();
            }
        }

        isMoving() {
            return this.vx !== 0 || this.vy !== 0;
        }

        checkCushionCollision() {
            let hit = false;
            
            // Yastık (Bant) Çarpışma Kontrolü (Kenarlar)
            // Sol yastık
            if (this.x - this.radius < CUSHION_WIDTH) { this.x = CUSHION_WIDTH + this.radius; this.vx *= -1; hit = true; }
            // Sağ yastık
            if (this.x + this.radius > CANVAS_WIDTH - CUSHION_WIDTH) { this.x = CANVAS_WIDTH - CUSHION_WIDTH - this.radius; this.vx *= -1; hit = true; }
            // Üst yastık
            if (this.y - this.radius < CUSHION_WIDTH) { this.y = CUSHION_WIDTH + this.radius; this.vy *= -1; hit = true; }
            // Alt yastık
            if (this.y + this.radius > CANVAS_HEIGHT - CUSHION_WIDTH) { this.y = CANVAS_HEIGHT - CUSHION_WIDTH - this.radius; this.vy *= -1; hit = true; }

            if (hit && this.type === 'cue') {
                hitTargets.bands++;
                // İngiliz (falsolu vuruş) etkisi ekle
                this.vx = Math.cos(Math.atan2(this.vy, this.vx) + (englishX * SPIN_FACTOR)) * Math.hypot(this.vx, this.vy);
                this.vy = Math.sin(Math.atan2(this.vy, this.vx) + (englishY * SPIN_FACTOR)) * Math.hypot(this.vx, this.vy);
            }
        }
        
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);

            let drawColor = this.color;
            if (this.type === 'cue') {
                const customBall = shopItems.balls.find(b => b.name === playerData.selectedBall);
                if (customBall) {
                    drawColor = customBall.color;
                }
            }

            ctx.fillStyle = drawColor;
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2; 
            ctx.stroke();

            // English (Falso) noktası çiz
            if (this.type === 'cue') {
                ctx.beginPath();
                ctx.arc(this.x + englishX * 8, this.y + englishY * 8, 3, 0, Math.PI * 2); 
                ctx.fillStyle = '#111';
                ctx.fill();
            }
        }
    }


    // --- Oyun Mantığı ve Çekirdek Fonksiyonlar ---

    function initializeGame() {
        canvas = document.getElementById('billiardsCanvas');
        ctx = canvas.getContext('2d');
        englishCanvas = document.getElementById('englishCanvas');
        englishCtx = englishCanvas.getContext('2d');
        powerBarContainer = document.getElementById('powerBarContainer');
        cueHandle = document.getElementById('cueHandle');
        powerBarFill = document.getElementById('powerBarFill');


        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;
        
        // GÜNCELLENDİ: Güç çubuğunun maksimum çekilebileceği görsel mesafeyi hesapla
        const containerPaddingY = 2 * CUE_CONTAINER_PADDING; 
        VISUAL_BAR_HEIGHT = powerBarContainer.clientHeight - containerPaddingY; 
        
        // Başlangıçta görseli sıfırla
        updateCueHandleVisuals(); 

        const updateCanvasSize = () => {
            const container = document.getElementById('gameContainer');
            const ratio = CANVAS_WIDTH / CANVAS_HEIGHT; 

            let newWidth = container.clientWidth;
            let newHeight = container.clientHeight;

            if (newWidth / newHeight > ratio) {
                newWidth = newHeight * ratio;
            } else {
                newHeight = newWidth / ratio;
            }

            const margin = 50; 
            canvas.style.width = `${Math.min(newWidth - margin, CANVAS_WIDTH)}px`;
            canvas.style.height = `${Math.min(newHeight - margin, CANVAS_HEIGHT)}px`;
        };

        window.addEventListener('resize', updateCanvasSize);
        updateCanvasSize(); 

        loadGameData();
        loadLevel(level);

        // Giriş dinleyicileri (Nişan Açısı - Canvas)
        canvas.addEventListener('mousedown', handlePointerDown);
        canvas.addEventListener('mousemove', handlePointerMove);
        canvas.addEventListener('mouseup', handlePointerUp);
        canvas.addEventListener('touchstart', handlePointerDown);
        canvas.addEventListener('touchmove', handlePointerMove);
        canvas.addEventListener('touchend', handlePointerUp);

        // Giriş dinleyicileri (Falso - English Canvas)
        englishCanvas.addEventListener('mousedown', handleEnglishDown);
        englishCanvas.addEventListener('mousemove', handleEnglishMove);
        englishCanvas.addEventListener('mouseup', handleEnglishUp);
        englishCanvas.addEventListener('touchstart', handleEnglishDown);
        englishCanvas.addEventListener('touchmove', handleEnglishMove);
        englishCanvas.addEventListener('touchend', handleEnglishUp);
        
        // Giriş dinleyicileri (Güç - KESİNTİSİZ ÇEKME İÇİN DÜZELTİLDİ)
        powerBarContainer.addEventListener('mousedown', handleCueSliderDown);
        powerBarContainer.addEventListener('touchstart', handleCueSliderDown);
        
        // DÜZELTME #4: Çekmeyi bırakma ve hareket etme olaylarını Document'e bağla (Dikdörtgen dışına çıkma sorununu çözer)
        document.addEventListener('mousemove', handleCueSliderMove);
        document.addEventListener('mouseup', handleCueSliderUp);
        document.addEventListener('touchmove', handleCueSliderMove);
        document.addEventListener('touchend', handleCueSliderUp);

        document.getElementById('pauseButton').addEventListener('click', () => showScreen('pause_menu'));

        gameReady = true;
        showScreen('main_menu');
        gameLoop();
    }

    function loadLevel(lvl) {
        const currentLevelData = levels[(lvl - 1) % levels.length];
        if (!currentLevelData) {
            showScreen('game_end'); 
            return;
        }

        level = lvl;
        shotAttempt = 1;
        isBallMoving = false;
        isAiming = true; // Toplar durduğu an nişan alma başlar
        shotPower = 0;
        
        // UI elemanlarını göster
        document.getElementById('englishSelector').style.display = 'block'; 
        document.getElementById('powerBarContainer').style.display = 'block';

        // Topları sıfırla
        balls = [];
        const cueBallData = currentLevelData.white;
        balls.push(new Ball(cueBallData.x, cueBallData.y, CUE_BALL_COLOR, 'cue'));
        balls.push(new Ball(currentLevelData.red.x, currentLevelData.red.y, OBJECT_BALL_COLOR, 'red'));
        balls.push(new Ball(currentLevelData.yellow.x, currentLevelData.yellow.y, OBJECT_BALL_2_COLOR, 'yellow'));
        
        // Başlangıç nişan noktası (Cue Ball'ın üstüne)
        aimTargetPos = { x: cueBallData.x, y: cueBallData.y - 100 }; 
        resetShotTargets();
        cueHandleVisualY = 0; // İsteka pozisyonunu sıfırla
        updateCueHandleVisuals(); // Görseli ve güç barını sıfırla
    }

    function resetShotTargets() {
         hitTargets = { red: false, yellow: false, bands: 0 };
    }

    function gameLoop() {
        if (gameReady) {
            update();
            draw();
            checkGameState();
            
            // Toplar durduysa nişan alma aşamasını başlat
            if (!isBallMoving && currentScreen === 'game') {
                isAiming = true;
                document.getElementById('englishSelector').style.display = 'block';
                document.getElementById('powerBarContainer').style.display = 'block';
            } else {
                 isAiming = false;
            }
        }
        requestAnimationFrame(gameLoop);
    }

    function update() {
        if (currentScreen !== 'game') return;

        let allStopped = true;
        balls.forEach(ball => {
            ball.update();
            if (ball.isMoving()) {
                allStopped = false;
            }
        });

        isBallMoving = !allStopped;
        
        if (isBallMoving) {
            // Çarpışmaları kontrol et
            for (let i = 0; i < balls.length; i++) {
                for (let j = i + 1; j < balls.length; j++) {
                    checkBallCollision(balls[i], balls[j]);
                }
            }
        }
    }

    function checkGameState() {
        if (currentScreen !== 'game') return;

        if (!isBallMoving && !isAiming) {
            
            if (hitTargets.red && hitTargets.yellow && hitTargets.bands >= 3) {
                // KAZANÇ
                showScreen('level_complete');
            } else {
                // KAYIP/FAUL
                console.log(`Faul! 3 bant gerekiyordu, sadece ${hitTargets.bands} vuruş yapıldı. Otomatik level yeniden başlatılıyor.`);
                loadLevel(level); // Otomatik yeniden başlat
            }
            
            resetShotTargets();
            shotPower = 0;
            isAiming = true; // Yeniden nişan almaya başla
        } 
    }

    function checkBallCollision(b1, b2) {
        const dx = b2.x - b1.x;
        const dy = b2.y - b1.y;
        const distSq = dx * dx + dy * dy;
        const minDist = b1.radius + b2.radius;

        if (distSq <= minDist * minDist) {
            const dist = Math.sqrt(distSq);
            const nx = dx / dist; 
            const ny = dy / dist; 

            const overlap = minDist - dist;
            b1.x -= overlap * 0.5 * nx;
            b1.y -= overlap * 0.5 * ny;
            b2.x += overlap * 0.5 * nx;
            b2.y += overlap * 0.5 * ny;

            const v1n = b1.vx * nx + b1.vy * ny;
            const v2n = b2.vx * nx + b2.vy * ny;

            if (v1n > 0 || v2n < 0) {
                 const newV1n = v2n;
                 const newV2n = v1n;

                 b1.vx += (newV1n - v1n) * nx;
                 b1.vy += (newV1n - v1n) * ny;
                 b2.vx += (newV2n - v2n) * nx;
                 b2.vy += (newV2n - v2n) * ny;

                if (b1.type === 'cue' || b2.type === 'cue') {
                    const otherBall = b1.type === 'cue' ? b2 : b1;
                    if (otherBall.type === 'red') hitTargets.red = true;
                    if (otherBall.type === 'yellow') hitTargets.yellow = true;
                }
            }
        }
    }

    function draw() {
        // Tuvali Temizle
        ctx.fillStyle = '#034827';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

        // Dış Bantları Çiz
        ctx.fillStyle = '#056238';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CUSHION_WIDTH); 
        ctx.fillRect(0, CANVAS_HEIGHT - CUSHION_WIDTH, CANVAS_WIDTH, CUSHION_WIDTH); 
        ctx.fillRect(0, CUSHION_WIDTH, CUSHION_WIDTH, CANVAS_HEIGHT - 2 * CUSHION_WIDTH); 
        ctx.fillRect(CANVAS_WIDTH - CUSHION_WIDTH, CUSHION_WIDTH, CUSHION_WIDTH, CANVAS_HEIGHT - 2 * CUSHION_WIDTH); 

        // Topları çiz
        balls.forEach(ball => ball.draw());

        // Nişan alma çizimlerini yap
        if (isAiming) {
            drawAiming();
        }

        // Seviye metni çiz
        ctx.fillStyle = TEXT_COLOR;
        ctx.font = 'bold 24px Inter';
        ctx.textAlign = 'left';
        // Sadece Level bilgisini göster
        ctx.fillText(`Level: ${level}`, 20, 40); 

        // English Seçici UI çiz
        drawEnglishSelector();
    }

    function drawAiming() {
        const cueBall = balls[0];
        
        // Nişan açısı sürekli olarak imleç pozisyonundan hesaplanır
        const currentAngle = Math.atan2(aimTargetPos.y - cueBall.y, aimTargetPos.x - cueBall.x);

        // --- Noktalı Nişan Çizgisi ---
        ctx.setLineDash([5, 5]);
        ctx.strokeStyle = '#FFF'; 
        ctx.lineWidth = 2;
        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.moveTo(cueBall.x, cueBall.y);
        
        const lineEndX = cueBall.x + Math.cos(currentAngle) * 1000;
        const lineEndY = cueBall.y + Math.sin(currentAngle) * 1000;
        
        ctx.lineTo(lineEndX, lineEndY);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.globalAlpha = 1.0;

        // İsteka çubuğu görsel geri bildirimi
        if (shotPower > 0.1) {
            const cueLength = 100;
            const cueTipGap = BALL_RADIUS + 5; 
            
            // Güce göre geri çekilme mesafesi (Bu görsel geri bildirim isteka çubuğundaki hareketten bağımsızdır)
            const powerRatio = shotPower / MAX_SHOT_POWER;
            const pullBackDist = powerRatio * 50; 

            // İsteka, atış açısının tam tersi yönüne yerleştirilir
            const cueStartDist = cueTipGap + pullBackDist; 
            const cueEndDist = cueStartDist + cueLength;

            const cueStartX = cueBall.x - Math.cos(currentAngle) * cueStartDist;
            const cueStartY = cueBall.y - Math.sin(currentAngle) * cueStartDist;
            const cueEndX = cueBall.x - Math.cos(currentAngle) * cueEndDist;
            const cueEndY = cueBall.y - Math.sin(currentAngle) * cueEndDist;

            ctx.strokeStyle = '#8B4513'; // Kahverengi isteka
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(cueStartX, cueStartY);
            ctx.lineTo(cueEndX, cueEndY);
            ctx.stroke();
        }
    }

    function drawEnglishSelector() {
        // English (Falso) Seçiciyi Çiz
        const size = englishCanvas.width;
        const center = size / 2;

        englishCtx.clearRect(0, 0, size, size);
        englishCtx.beginPath();
        englishCtx.arc(center, center, center - 2, 0, Math.PI * 2);
        englishCtx.fillStyle = CUE_BALL_COLOR;
        englishCtx.strokeStyle = '#aaa';
        englishCtx.lineWidth = 2;
        englishCtx.fill();
        englishCtx.stroke();

        const markerX = center + englishX * (center - 5);
        const markerY = center + englishY * (center - 5);

        englishCtx.beginPath();
        englishCtx.arc(markerX, markerY, 5, 0, Math.PI * 2);
        englishCtx.fillStyle = '#000';
        englishCtx.fill();
    }


    // --- Giriş İşleyicileri (Nişan Açısı - Canvas) ---

    function getRelativeCoordinates(e, element) {
        const rect = element.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        
        if (element.id === 'billiardsCanvas') {
            const scaleX = CANVAS_WIDTH / rect.width;
            const scaleY = CANVAS_HEIGHT / rect.height;
            return { x: x * scaleX, y: y * scaleY };
        }
        return { x: x, y: y };
    }

    function handlePointerDown(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming) return;

        // Sadece Canvas'ta nişan alma sürüklemesini başlat
        if (e.target === canvas || e.target.id === 'billiardsCanvas') {
            isDragging = true;
            aimTargetPos = getRelativeCoordinates(e, canvas);
        }
    }

    function handlePointerMove(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming || !isDragging) return;

        // Sürükleme devam ederken nişan açısını sürekli güncelle
        aimTargetPos = getRelativeCoordinates(e, canvas);
    }

    function handlePointerUp(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming) return;
        
        // Sadece sürüklemeyi bitir, atış yapma güce bağlı
        isDragging = false;
    }
    
    // --- GÜÇ ÇUBUĞU HAREKET VE HASSASİYET DÜZELTMELERİ (YENİ VE DOĞRU MANTIK) ---
    
    // İsteka görselinin pozisyonunu ve güç barını günceller
    function updateCueHandleVisuals() {
        // İSTEKA GÖRSELİNİ GÜNCELLE: cueHandleVisualY, 0 (üst) ile VISUAL_BAR_HEIGHT (alt) arasında değişir.
        cueHandle.style.transform = `translateY(${cueHandleVisualY}px)`;
        
        // GÜÇ BARINI GÜNCELLE: shotPower'a göre doluluk oranını ayarla.
        updatePowerBar(shotPower);
    }

    function handleCueSliderDown(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming) return;
        
        // Tıklanan elemanın powerBarContainer olduğundan emin ol (Touch/Mouse)
        if (e.target.closest('#powerBarContainer')) {
            isSliderDragging = true;
            
            const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
            
            // Sürüklemenin başladığı ekran Y koordinatını kaydet
            dragStartScreenY = clientY; 
            
            // Başlangıçta görseli ve gücü sıfırla
            cueHandleVisualY = 0; 
            shotPower = 0; 
            updateCueHandleVisuals(); 
        }
    }
    
    // DÜZELTME #4: Bu fonksiyon artık document'ten dinleniyor (Sınırsız çekme için)
    function handleCueSliderMove(e) {
        if (!isSliderDragging || !isAiming) return;
        e.preventDefault();

        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : dragStartScreenY);
        
        // DÜZELTME #3: Ters Çekiş Yönü. Aşağı çekmek (clientY > dragStartScreenY) gücü artırır.
        const deltaY = clientY - dragStartScreenY; 
        
        // DÜZELTME #1: Hassasiyet. Çekme mesafesini SENSITIVITY ile sınırla.
        // powerDrag, 0 ile POWER_DRAG_SENSITIVITY (500px) arasındadır.
        const powerDrag = Math.min(Math.max(0, deltaY), POWER_DRAG_SENSITIVITY);

        // Güç Oranı (0.0 ile 1.0 arası)
        const powerRatio = powerDrag / POWER_DRAG_SENSITIVITY;
        
        // DÜZELTME #2: İsteka Çekme Oranını Eşitle (Aynı Oran)
        // İstekanın görsel pozisyonu, Güç Oranı * Görsel Yükseklik olacak.
        cueHandleVisualY = powerRatio * VISUAL_BAR_HEIGHT; 

        // Güç Hesaplama
        shotPower = powerRatio * MAX_SHOT_POWER;

        updateCueHandleVisuals(); 
    }

    // DÜZELTME #4: Bu fonksiyon artık document'ten dinleniyor (Sınırsız çekme için)
    function handleCueSliderUp(e) {
        if (!isSliderDragging || !isAiming) return;
        isSliderDragging = false;
        
        // Atış bittikten veya iptal edildikten sonra istekayı hemen yukarı çek (sıfırla)
        cueHandleVisualY = 0;
        
        if (shotPower > 0.5) { // Minimum güç sınırı (0.5 power)
            isAiming = false;
            document.getElementById('powerBarContainer').style.display = 'none';
            document.getElementById('englishSelector').style.display = 'none';
            executeShot();
        } else {
            // Yeterli güç yoksa
            shotPower = 0; 
        }
        updateCueHandleVisuals(); // Görseli sıfırla
    }


    // English Selector Handlers (Falso Seçici İşleyicileri)
    let isEnglishDragging = false;
    function handleEnglishDown(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming) return; 
        isEnglishDragging = true;
        handleEnglishMove(e);
    }
    
    function handleEnglishMove(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || !isEnglishDragging) return;
        
        const rect = englishCanvas.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;

        const x = clientX - rect.left - rect.width / 2;
        const y = clientY - rect.top - rect.height / 2;
        const maxDist = rect.width / 2 - 5;
        const dist = Math.hypot(x, y);

        if (dist <= maxDist) {
            englishX = x / maxDist; // -1 ile 1 arasında normalize edildi
            englishY = y / maxDist;
        } else {
             // Kenara sabitle
            englishX = x / dist;
            englishY = y / dist;
        }
        drawEnglishSelector();
    }
    
    function handleEnglishUp(e) {
        e.preventDefault();
        isEnglishDragging = false;
    }


    function updatePowerBar(power) {
        const powerLevel = Math.min(power / MAX_SHOT_POWER, 1);
        
        // Dikey çubuk olduğu için yüksekliği ayarla (Alttan yukarı doluyor)
        powerBarFill.style.height = `${powerLevel * 100}%`;

        // Güce göre renk değiştir
        if (powerLevel < 0.33) {
            powerBarFill.style.backgroundColor = '#22c55e'; // Yeşil
        } else if (powerLevel < 0.66) {
            powerBarFill.style.backgroundColor = '#facc15'; // Sarı
        } else {
            powerBarFill.style.backgroundColor = '#ef4444'; // Kırmızı
        }
    }

    function executeShot() {
        const cueBall = balls[0];

        // Atış anındaki son nişan açısını hesapla
        shotAngle = Math.atan2(aimTargetPos.y - cueBall.y, aimTargetPos.x - cueBall.x);

        // Güç ve isteka çarpanını uygula
        const totalPower = shotPower * currentCue.powerMultiplier;

        cueBall.vx = Math.cos(shotAngle) * totalPower;
        cueBall.vy = Math.sin(shotAngle) * totalPower;

        isBallMoving = true;
        shotAttempt++;
    }

    // --- UI/Screen Management (Ekran Yönetimi) ---

    function showScreen(screenId) {
        currentScreen = screenId;
        const container = document.getElementById('screenContainer');
        const pauseButton = document.getElementById('pauseButton');
        container.innerHTML = '';
        container.style.display = 'flex';
        pauseButton.classList.add('hidden');
        document.getElementById('englishSelector').style.display = 'none';
        document.getElementById('powerBarContainer').style.display = 'none';

        switch (screenId) {
            case 'main_menu':
                container.innerHTML = createMainMenu();
                break;
            case 'options':
                container.innerHTML = createOptionsScreen();
                break;
            case 'shop':
                container.innerHTML = createShopScreen();
                break;
            case 'game':
                container.style.display = 'none';
                pauseButton.classList.remove('hidden');
                
                // Oyun devam ederken UI elemanlarının görünürlüğünü kontrol et
                if (!isBallMoving) {
                    document.getElementById('englishSelector').style.display = 'block';
                    document.getElementById('powerBarContainer').style.display = 'block';
                    isAiming = true;
                }
                break;
            case 'pause_menu':
                container.innerHTML = createPauseMenu();
                break;
            case 'level_complete':
                container.innerHTML = createLevelCompleteScreen();
                break;
            case 'game_end':
                container.innerHTML = createGameEndScreen();
                break;
        }
        attachButtonListeners();
    }
    
    function attachButtonListeners() {
        document.querySelectorAll('.js-button').forEach(button => {
            button.addEventListener('click', () => {
                const action = button.getAttribute('data-action');
                handleMenuAction(action);
            });
        });
    }

    function handleMenuAction(action) {
        switch (action) {
            case 'start':
                loadLevel(playerData.currentLevel);
                showScreen('game');
                break;
            case 'options':
                showScreen('options');
                break;
            case 'shop':
                showScreen('shop');
                break;
            case 'continue':
                showScreen('game');
                break;
            case 'main_menu':
                showScreen('main_menu');
                break;
            case 'next_level':
                playerData.currentLevel++;
                saveGameData();
                loadLevel(playerData.currentLevel);
                showScreen('game');
                break;
            case 'toggle_sfx':
                playerData.sfx = !playerData.sfx;
                saveGameData();
                showScreen('options');
                break;
            case 'toggle_music':
                playerData.music = !playerData.music;
                saveGameData();
                showScreen('options');
                break;
        }
    }
    
    function showMessageBox(title, message, onConfirm = null) {
        const container = document.getElementById('screenContainer');
        container.style.display = 'flex';
        container.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm text-center">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <button id="msgBoxOk" class="game-button">ANLADIM</button>
            </div>
        `;
        currentScreen = 'message_box'; 
        
        document.getElementById('msgBoxOk').addEventListener('click', () => {
            if (onConfirm) onConfirm();
            if(currentScreen === 'message_box') showScreen('game'); 
        });
    }

    function createMainMenu() {
        return `
            <div class="p-8 text-center bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
                <h1 class="text-4xl font-extrabold text-yellow-400 mb-8">3-CUSHION CAROM</h1>
                <div class="flex flex-col space-y-4">
                    <button class="game-button js-button" data-action="start">Başla (Level ${playerData.currentLevel})</button>
                    <button class="game-button js-button" data-action="options">Ayarlar</button>
                    <button class="game-button js-button" data-action="shop">Mağaza</button>
                </div>
            </div>
        `;
    }

    function createPauseMenu() {
        return `
            <div class="p-8 text-center bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
                <h1 class="text-3xl font-bold text-white mb-6">Oyun Duraklatıldı</h1>
                <div class="flex flex-col space-y-4">
                    <button class="game-button js-button" data-action="continue">Devam Et</button>
                    <button class="game-button js-button" data-action="options">Ayarlar</button>
                    <button class="game-button js-button" data-action="main_menu">Ana Menü</button>
                </div>
            </div>
        `;
    }

    function calculateCoins() {
        const baseCoins = 100;
        let bonus = 0;
        if (shotAttempt === 1) bonus = 50;
        if (shotAttempt <= 3) bonus = 20;

        const earnedCoins = baseCoins + bonus;
        playerData.coins += earnedCoins;
        saveGameData();
        return earnedCoins;
    }

    function createLevelCompleteScreen() {
        const earned = calculateCoins();
        return `
            <div class="p-8 text-center bg-green-700 rounded-xl shadow-2xl w-full max-w-sm text-white">
                <h1 class="text-4xl font-extrabold mb-4">LEVEL TAMAMLANDI!</h1>
                <p class="text-lg mb-2">Deneme Sayısı: ${shotAttempt}</p>
                <p class="text-2xl font-bold mb-6">Kazanılan Para: <span class="text-yellow-300">${earned}</span></p>
                <p class="text-lg mb-6">Toplam Para: ${playerData.coins}</p>
                <div class="flex flex-col space-y-4">
                    <button class="game-button bg-green-900 js-button" data-action="next_level">Sonraki Level</button>
                    <button class="game-button js-button" data-action="main_menu">Ana Menü</button>
                </div>
            </div>
        `;
    }
    
    function createGameEndScreen() {
        return `
            <div class="p-8 text-center bg-yellow-500 rounded-xl shadow-2xl w-full max-w-sm text-gray-900">
                <h1 class="text-4xl font-extrabold mb-4">TEBRİKLER!</h1>
                <p class="text-xl mb-6">Tüm mevcut levelleri tamamladınız!</p>
                <p class="text-lg mb-6">Toplam Para: ${playerData.coins}</p>
                <div class="flex flex-col space-y-4">
                    <button class="game-button bg-yellow-700 text-white js-button" data-action="shop">Mağazayı Ziyaret Et</button>
                    <button class="game-button bg-gray-700 text-white js-button" data-action="main_menu">Ana Menü</button>
                </div>
            </div>
        `;
    }

    function createOptionsScreen() {
        const sfxText = playerData.sfx ? 'AÇIK' : 'KAPALI';
        const musicText = playerData.music ? 'AÇIK' : 'KAPALI';

        return `
            <div class="p-8 text-center bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm text-white">
                <h1 class="text-3xl font-bold mb-6">Ayarlar</h1>
                <div class="flex flex-col space-y-4">
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                        <span>Ses Efektleri:</span>
                        <button class="game-button text-sm px-4 py-2 ${playerData.sfx ? 'bg-green-600' : 'bg-red-600'} js-button" data-action="toggle_sfx">${sfxText}</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                        <span>Müzik:</span>
                        <button class="game-button text-sm px-4 py-2 ${playerData.music ? 'bg-green-600' : 'bg-red-600'} js-button" data-action="toggle_music">${musicText}</button>
                    </div>
                    <button class="game-button bg-gray-500 hover:bg-gray-600 js-button" data-action="main_menu">Geri</button>
                </div>
            </div>
        `;
    }

    function createShopScreen() {
        let shopHtml = `
            <div class="p-8 text-center bg-gray-800 rounded-xl shadow-2xl w-full max-w-md text-white">
                <h1 class="text-3xl font-bold mb-2">Mağaza</h1>
                <p class="text-yellow-400 text-xl mb-6">Para: ${playerData.coins} 💰</p>
                
                <h2 class="text-2xl font-semibold mt-6 mb-3 border-b border-gray-700 pb-1">İstekalar (Güç)</h2>
        `;

        // Cues Section
        shopItems.cues.forEach(item => {
            const isOwned = playerData.ownedCues.includes(item.name);
            const isSelected = playerData.selectedCue === item.name;
            const buttonText = isOwned ? (isSelected ? 'KULLANILIYOR' : 'Kullan') : `Satın Al - ${item.price} 💰`;
            const buttonColor = isOwned ? (isSelected ? 'bg-green-600' : 'bg-blue-600') : (playerData.coins >= item.price ? 'bg-red-500' : 'bg-gray-600');

            shopHtml += `
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg mb-3">
                    <div class="text-left">
                        <span class="font-bold">${item.name}</span> 
                        <span class="text-sm text-gray-400"> (Güç x${item.powerMultiplier.toFixed(1)})</span>
                        <p class="text-xs text-gray-400">${item.description}</p>
                    </div>
                    <button class="game-button text-sm px-4 py-2 ${buttonColor} js-shop-item" data-type="cue" data-name="${item.name}" data-price="${item.price}" data-owned="${isOwned}" data-selected="${isSelected}" ${!isOwned && playerData.coins < item.price ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
            `;
        });
        
        shopHtml += `<h2 class="text-2xl font-semibold mt-6 mb-3 border-b border-gray-700 pb-1">Toplar (Kozmetik)</h2>`;

        // Balls Section
        shopItems.balls.forEach(item => {
            const isOwned = playerData.ownedBalls.includes(item.name);
            const isSelected = playerData.selectedBall === item.name;
            const buttonText = isOwned ? (isSelected ? 'KULLANILIYOR' : 'Kullan') : `Satın Al - ${item.price} 💰`;
            const buttonColor = isOwned ? (isSelected ? 'bg-green-600' : 'bg-blue-600') : (playerData.coins >= item.price ? 'bg-red-500' : 'bg-gray-600');

            shopHtml += `
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg mb-3">
                    <div class="text-left">
                        <div class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${item.color}; border: 1px solid #fff;"></div>
                        <span class="font-bold">${item.name}</span> 
                        <p class="text-xs text-gray-400">${item.description}</p>
                    </div>
                    <button class="game-button text-sm px-4 py-2 ${buttonColor} js-shop-item" data-type="ball" data-name="${item.name}" data-price="${item.price}" data-owned="${isOwned}" data-selected="${isSelected}" ${!isOwned && playerData.coins < item.price ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
            `;
        });


        shopHtml += `
                <button class="game-button bg-gray-500 hover:bg-gray-600 mt-6 js-button" data-action="main_menu">Geri</button>
            </div>
        `;

        // Attach shop-specific listeners
        setTimeout(() => {
             document.querySelectorAll('.js-shop-item').forEach(button => {
                button.addEventListener('click', () => {
                    handleShopAction(button);
                });
            });
        }, 0);

        return shopHtml;
    }

    function handleShopAction(button) {
        const type = button.getAttribute('data-type');
        const name = button.getAttribute('data-name');
        const price = parseInt(button.getAttribute('data-price'));
        const isOwned = button.getAttribute('data-owned') === 'true';
        const isSelected = button.getAttribute('data-selected') === 'true';

        if (!isOwned) {
            // Buy item
            if (playerData.coins >= price) {
                playerData.coins -= price;
                if (type === 'cue') playerData.ownedCues.push(name);
                if (type === 'ball') playerData.ownedBalls.push(name);
                showMessageBox("Satın Alma Başarılı!", `${name} envanterinize eklendi.`, () => {
                    // Equip after purchase
                    if (type === 'cue') playerData.selectedCue = name;
                    if (type === 'ball') playerData.selectedBall = name;
                    currentCue = shopItems.cues.find(c => c.name === name) || shopItems.cues[0];
                    saveGameData();
                    showScreen('shop');
                });

            } else {
                 showMessageBox("Yetersiz Para", `Satın almak için ${price - playerData.coins} paraya daha ihtiyacın var.`);
            }
        } else if (!isSelected) {
            // Equip item
            if (type === 'cue') playerData.selectedCue = name;
            if (type === 'ball') playerData.selectedBall = name;
            currentCue = shopItems.cues.find(c => c.name === name) || shopItems.cues[0];
            saveGameData();
            showScreen('shop');
        }
    }


    // Initialize the game when the window loads
    window.onload = initializeGame;

    console.log("NOTE: This application uses localStorage instead of Firebase for persistence.");
</script>

</body>
</html>
