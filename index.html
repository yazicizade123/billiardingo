<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-Cushion Bilardo Oyunu</title>
    <!-- Tailwind CSS CDN for responsive and modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the game to ensure full screen mobile experience */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            overflow: hidden; /* Prevent scrolling on mobile */
        }

        /* Game Container: Flexible to fit the vertical canvas */
        #gameContainer {
            width: 100vw;
            height: 100vh;
            max-width: 900px; 
            max-height: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Canvas for the Billiards Table */
        #billiardsCanvas {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            border: 10px solid #333; /* Rail/Frame color */
            border-radius: 8px;
            touch-action: none; /* Crucial for better touch input on table */
            max-width: 90%; 
            max-height: 90%;
            background-color: #034827; /* Green cloth */
            margin-right: 60px; /* GÃ¼Ã§ Ã§ubuÄŸu iÃ§in saÄŸda boÅŸluk bÄ±rak */
        }
        
        @media (min-width: 640px) {
            /* Masa Ã¼stÃ¼ cihazlarda daha fazla boÅŸluk */
            #billiardsCanvas {
                 margin-right: 120px; 
            }
        }


        /* General styles for buttons */
        .game-button {
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            background-color: #4f46e5;
            color: white;
            border: none;
            margin: 8px;
            font-size: 1.1rem;
        }

        .game-button:hover, .game-button:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        }

        /* Dikey GÃ¼Ã§ Ä°stekasÄ± (Power Bar) Stili */
        #powerBarContainer {
            position: absolute;
            right: 4px; /* Masa kenarÄ±na yakÄ±n */
            top: 15%; 
            width: 60px; 
            height: 350px; 
            background-color: #2D3748; /* Koyu Gri Zemin */
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            border: 2px solid #aaa; 
            z-index: 100;
            display: none; 
            cursor: pointer; 
            touch-action: none; 
            padding: 10px 0; 
            box-sizing: border-box; 
        }
        
        @media (min-width: 640px) {
            #powerBarContainer {
                right: 40px; 
            }
        }

        /* GÃ¼Ã§ BarÄ± Dolumu */
        #powerBarFill {
            width: 100%;
            height: 0%; 
            background-color: #ef4444; 
            position: absolute;
            bottom: 0; 
            transition: height 0.05s ease-out, background-color 0.2s;
            border-radius: 0 0 8px 8px;
            z-index: 100; 
        }

        /* Ä°steka Handle: ArtÄ±k gÃ¶rsel hareketi bu taÅŸÄ±yor */
        #cueHandle {
            position: absolute;
            top: 10px; /* Ãœst padding'den baÅŸla */
            left: 0;
            width: 100%;
            height: calc(100% - 20px); /* Konteyner yÃ¼ksekliÄŸi - 2 * padding */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Ä°steka baÅŸlangÄ±Ã§ta en Ã¼stte dursun */
            touch-action: none; 
            z-index: 101; 
            pointer-events: none; /* Sadece powerBarContainer'Ä± dinleyeceÄŸiz */
            transition: transform 0.05s ease-out; /* HÄ±zlÄ± hareket iÃ§in */
            transform: translateY(0px); /* BaÅŸlangÄ±Ã§ konumu */
        }

        #cueHandle svg {
            /* Dikey Ä°steka SVG boyutu */
            height: 100%; /* Konteyneri kapla */
            width: 8px;
            filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.8));
        }
        
        /* English Selector area repositioned to be under the power bar */
        #englishSelector {
            position: absolute;
            right: 0px; 
            top: calc(15% + 350px + 20px); 
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 2px solid #aaa;
            cursor: pointer;
            z-index: 100;
            display: none; 
        }

        @media (min-width: 640px) {
            #englishSelector {
                right: 30px; 
            }
        }
        
    </style>
</head>
<body>

<div id="gameContainer" class="p-4 sm:p-8">
    <!-- Game Canvas -->
    <canvas id="billiardsCanvas"></canvas>

    <!-- Main Menu / Screen Container -->
    <div id="screenContainer" class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-95 z-20">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <!-- Pause Button (always visible during gameplay) -->
    <button id="pauseButton" class="game-button absolute top-4 right-4 text-sm px-3 py-2 z-10 hidden">DURAKLAT</button>

    <!-- Dikey GÃ¼Ã§ Ä°stekasÄ± (Power Bar) -->
    <div id="powerBarContainer">
        <!-- GÃ¼Ã§ dolumu alttan yukarÄ± dolsun diye fill altta -->
        <div id="powerBarFill"></div>
        
        <!-- Ä°steka Handle (GÃ¶rsel ve SÃ¼rÃ¼kleme AlanÄ±) -->
        <div id="cueHandle">
            <!-- Dikey Ä°steka SVG Ä°konu -->
            <svg viewBox="0 0 8 330" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Ä°steka GÃ¶vdesi (Uzun ve Kahverengi) -->
                <rect x="0" y="0" width="8" height="330" rx="4" fill="#A0522D"/> 
                <!-- Ä°steka Ucu (Tip - En Ã¼stte) -->
                <circle cx="4" cy="4" r="3" fill="#FFE4B5"/> 
                <!-- Kuyruk Topuzu (En altta) -->
                <circle cx="4" cy="326" r="4" fill="#333333"/> 
            </svg>
        </div>
    </div>
    
    <!-- English/Spin Selection Area (Power bar'Ä±n altÄ±na taÅŸÄ±ndÄ±) -->
    <div id="englishSelector">
        <canvas id="englishCanvas" width="80" height="80"></canvas>
    </div>

</div>

<script>
    // Sabitler (DÄ°KEY MASA VE BÃœYÃœK TOPLAR Ä°Ã‡Ä°N GÃœNCELLENDÄ°)
    const CANVAS_WIDTH = 400;  // Dikey masa geniÅŸliÄŸi
    const CANVAS_HEIGHT = 800; // Dikey masa yÃ¼ksekliÄŸi
    const BALL_RADIUS = 20;    // Top boyutu
    const CUSHION_WIDTH = 10; 
    const FRICTION = 0.99; 
    const SPIN_FACTOR = 0.005; 
    const MIN_VELOCITY = 0.1; 
    const MAX_SHOT_POWER = 15;
    
    // YENÄ° HASSASÄ°YET AYARI (Gereken Ã§ekme mesafesi artÄ±rÄ±ldÄ±)
    const POWER_DRAG_SENSITIVITY = 500; // Maksimum gÃ¼ce ulaÅŸmak iÃ§in ekranda Ã§ekilmesi gereken piksel mesafesi. Bu deÄŸer ne kadar bÃ¼yÃ¼kse, hassasiyet o kadar artar.
    
    const CUE_BALL_COLOR = '#FFFFFF';
    const OBJECT_BALL_COLOR = '#FF0000'; // KÄ±rmÄ±zÄ±
    const OBJECT_BALL_2_COLOR = '#FFFF00'; // SarÄ±
    const TEXT_COLOR = '#E5E7EB';

    // --- OYUN VERÄ°LERÄ° (LEVELS ve SHOPITEMS) ---
    
    // Level KonumlarÄ± (Beyaz, KÄ±rmÄ±zÄ±, SarÄ±)
    const levels = [
        // Level 1: Basic setup for 3-cushion (Easy)
        {
            white: { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT * 0.8 },
            red: { x: CANVAS_WIDTH * 0.3, y: CANVAS_HEIGHT * 0.25 },
            yellow: { x: CANVAS_WIDTH * 0.7, y: CANVAS_HEIGHT * 0.45 }
        },
        // Level 2: Slightly more challenging
        {
            white: { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT * 0.75 },
            red: { x: CANVAS_WIDTH * 0.25, y: CANVAS_HEIGHT * 0.35 },
            yellow: { x: CANVAS_WIDTH * 0.6, y: CANVAS_HEIGHT * 0.15 }
        },
        // Level 3: Corner shot focus
        {
            white: { x: CANVAS_WIDTH * 0.7, y: CANVAS_HEIGHT * 0.6 },
            red: { x: CANVAS_WIDTH * 0.8, y: CANVAS_HEIGHT * 0.15 },
            yellow: { x: CANVAS_WIDTH * 0.2, y: CANVAS_HEIGHT * 0.2 }
        }
    ];

    // DÃ¼kkan Ã–ÄŸeleri (Ä°stekalar ve Toplar)
    const shopItems = {
        cues: [
            { name: "Standard Cue", powerMultiplier: 1.0, price: 0, description: "Standart isteka. GÃ¼Ã§lÃ¼ ve gÃ¼venilir." },
            { name: "Power Max Cue", powerMultiplier: 1.5, price: 1000, description: "Daha sert vuruÅŸlar iÃ§in ekstra gÃ¼Ã§." },
            { name: "Control Pro Cue", powerMultiplier: 1.1, price: 2500, description: "Hafif gÃ¼Ã§ artÄ±ÅŸÄ±, falsoda daha iyi kontrol." }
        ],
        balls: [
            { name: "Default", color: CUE_BALL_COLOR, price: 0, description: "Standart beyaz top." },
            { name: "Blue Marble", color: '#00BFFF', price: 500, description: "Mavi mermer efektli beyaz top." },
            { name: "Gold Dust", color: '#FFD700', price: 1500, description: "AltÄ±n tozu desenli lÃ¼ks top." }
        ]
    };

    // Oyun Durum DeÄŸiÅŸkenleri
    let currentScreen = 'main_menu';
    let gameReady = false;
    let canvas, ctx;
    let englishCanvas, englishCtx;
    let powerBarContainer, cueHandle, powerBarFill;
    let balls = [];
    let level = 1;
    let shotAttempt = 1;

    // NiÅŸan Alma MekaniÄŸi DeÄŸiÅŸkenleri
    let isAiming = false; 
    let isDragging = false; 
    let aimTargetPos = { x: 0, y: 0 }; 
    let shotAngle = 0; 
    let shotPower = 0;
    
    // GÃœÃ‡ Ã‡UBUÄžU VE HAREKET DEÄžÄ°ÅžKENLERÄ°
    let isSliderDragging = false; 
    let dragStartScreenY = 0; 
    let VISUAL_BAR_HEIGHT = 0; // GÃ¼Ã§ Ã§ubuÄŸunun net gÃ¶rsel yÃ¼ksekliÄŸi
    let cueHandleVisualY = 0; // Ä°steka gÃ¶rselinin pozisyonu (0'dan VISUAL_BAR_HEIGHT'a kadar)
    
    let englishX = 0; 
    let englishY = 0; 
    let isBallMoving = false;
    let hitTargets = { red: false, yellow: false, bands: 0 };
    let currentCue = { name: "Standard Cue", powerMultiplier: 1.0, price: 0 };
    
    const CUE_CONTAINER_PADDING = 10; 

    // Player Data (Managed by localStorage)
    let playerData = {
        coins: 0,
        currentLevel: 1,
        ownedCues: ["Standard Cue"],
        ownedBalls: ["Default"],
        selectedCue: "Standard Cue",
        selectedBall: "Default",
        sfx: true,
        music: true
    };

    const getUserId = () => 'local_user';

    // --- Persistence Functions (localStorage) ---

    function loadGameData() {
        const data = localStorage.getItem(`billiards_data_${getUserId()}`);
        if (data) {
            playerData = JSON.parse(data);
            level = playerData.currentLevel;
            currentCue = shopItems.cues.find(c => c.name === playerData.selectedCue) || shopItems.cues[0];
        }
        if (!playerData.ownedCues.includes("Standard Cue")) playerData.ownedCues.push("Standard Cue");
        if (!playerData.ownedBalls.includes("Default")) playerData.ownedBalls.push("Default");
    }

    function saveGameData() {
        localStorage.setItem(`billiards_data_${getUserId()}`, JSON.stringify(playerData));
    }

    // --- Ball Class (Top SÄ±nÄ±fÄ± - BasitleÅŸtirilmiÅŸ) ---
    class Ball {
        // ... (Ball class iÃ§eriÄŸi aynÄ± kaldÄ±)
        constructor(x, y, color, type) {
            this.x = x;
            this.y = y;
            this.vx = 0;
            this.vy = 0;
            this.radius = BALL_RADIUS;
            this.color = color;
            this.type = type; // 'cue', 'red', 'yellow'
            this.mass = 1;
        }

        update() {
            if (this.isMoving()) {
                this.x += this.vx;
                this.y += this.vy;

                this.vx *= FRICTION;
                this.vy *= FRICTION;

                if (Math.hypot(this.vx, this.vy) < MIN_VELOCITY) {
                    this.vx = 0;
                    this.vy = 0;
                }

                this.checkCushionCollision();
            }
        }

        isMoving() {
            return this.vx !== 0 || this.vy !== 0;
        }

        checkCushionCollision() {
            let hit = false;
            
            // YastÄ±k (Bant) Ã‡arpÄ±ÅŸma KontrolÃ¼ (Kenarlar)
            // Sol yastÄ±k
            if (this.x - this.radius < CUSHION_WIDTH) { this.x = CUSHION_WIDTH + this.radius; this.vx *= -1; hit = true; }
            // SaÄŸ yastÄ±k
            if (this.x + this.radius > CANVAS_WIDTH - CUSHION_WIDTH) { this.x = CANVAS_WIDTH - CUSHION_WIDTH - this.radius; this.vx *= -1; hit = true; }
            // Ãœst yastÄ±k
            if (this.y - this.radius < CUSHION_WIDTH) { this.y = CUSHION_WIDTH + this.radius; this.vy *= -1; hit = true; }
            // Alt yastÄ±k
            if (this.y + this.radius > CANVAS_HEIGHT - CUSHION_WIDTH) { this.y = CANVAS_HEIGHT - CUSHION_WIDTH - this.radius; this.vy *= -1; hit = true; }

            if (hit && this.type === 'cue') {
                hitTargets.bands++;
                // Ä°ngiliz (falsolu vuruÅŸ) etkisi ekle
                this.vx = Math.cos(Math.atan2(this.vy, this.vx) + (englishX * SPIN_FACTOR)) * Math.hypot(this.vx, this.vy);
                this.vy = Math.sin(Math.atan2(this.vy, this.vx) + (englishY * SPIN_FACTOR)) * Math.hypot(this.vx, this.vy);
            }
        }
        
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);

            let drawColor = this.color;
            if (this.type === 'cue') {
                const customBall = shopItems.balls.find(b => b.name === playerData.selectedBall);
                if (customBall) {
                    drawColor = customBall.color;
                }
            }

            ctx.fillStyle = drawColor;
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2; 
            ctx.stroke();

            // English (Falso) noktasÄ± Ã§iz
            if (this.type === 'cue') {
                ctx.beginPath();
                ctx.arc(this.x + englishX * 8, this.y + englishY * 8, 3, 0, Math.PI * 2); 
                ctx.fillStyle = '#111';
                ctx.fill();
            }
        }
    }


    // --- Oyun MantÄ±ÄŸÄ± ve Ã‡ekirdek Fonksiyonlar ---

    function initializeGame() {
        canvas = document.getElementById('billiardsCanvas');
        ctx = canvas.getContext('2d');
        englishCanvas = document.getElementById('englishCanvas');
        englishCtx = englishCanvas.getContext('2d');
        powerBarContainer = document.getElementById('powerBarContainer');
        cueHandle = document.getElementById('cueHandle');
        powerBarFill = document.getElementById('powerBarFill');


        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;
        
        // GÃœNCELLENDÄ°: GÃ¼Ã§ Ã§ubuÄŸunun maksimum Ã§ekilebileceÄŸi gÃ¶rsel mesafeyi hesapla
        const containerPaddingY = 2 * CUE_CONTAINER_PADDING; 
        VISUAL_BAR_HEIGHT = powerBarContainer.clientHeight - containerPaddingY; 
        
        // BaÅŸlangÄ±Ã§ta gÃ¶rseli sÄ±fÄ±rla
        updateCueHandleVisuals(); 

        const updateCanvasSize = () => {
            const container = document.getElementById('gameContainer');
            const ratio = CANVAS_WIDTH / CANVAS_HEIGHT; 

            let newWidth = container.clientWidth;
            let newHeight = container.clientHeight;

            if (newWidth / newHeight > ratio) {
                newWidth = newHeight * ratio;
            } else {
                newHeight = newWidth / ratio;
            }

            const margin = 50; 
            canvas.style.width = `${Math.min(newWidth - margin, CANVAS_WIDTH)}px`;
            canvas.style.height = `${Math.min(newHeight - margin, CANVAS_HEIGHT)}px`;
        };

        window.addEventListener('resize', updateCanvasSize);
        updateCanvasSize(); 

        loadGameData();
        loadLevel(level);

        // GiriÅŸ dinleyicileri (NiÅŸan AÃ§Ä±sÄ± - Canvas)
        canvas.addEventListener('mousedown', handlePointerDown);
        canvas.addEventListener('mousemove', handlePointerMove);
        canvas.addEventListener('mouseup', handlePointerUp);
        canvas.addEventListener('touchstart', handlePointerDown);
        canvas.addEventListener('touchmove', handlePointerMove);
        canvas.addEventListener('touchend', handlePointerUp);

        // GiriÅŸ dinleyicileri (Falso - English Canvas)
        englishCanvas.addEventListener('mousedown', handleEnglishDown);
        englishCanvas.addEventListener('mousemove', handleEnglishMove);
        englishCanvas.addEventListener('mouseup', handleEnglishUp);
        englishCanvas.addEventListener('touchstart', handleEnglishDown);
        englishCanvas.addEventListener('touchmove', handleEnglishMove);
        englishCanvas.addEventListener('touchend', handleEnglishUp);
        
        // GiriÅŸ dinleyicileri (GÃ¼Ã§ - KESÄ°NTÄ°SÄ°Z Ã‡EKME Ä°Ã‡Ä°N DÃœZELTÄ°LDÄ°)
        powerBarContainer.addEventListener('mousedown', handleCueSliderDown);
        powerBarContainer.addEventListener('touchstart', handleCueSliderDown);
        
        // DÃœZELTME #4: Ã‡ekmeyi bÄ±rakma ve hareket etme olaylarÄ±nÄ± Document'e baÄŸla (DikdÃ¶rtgen dÄ±ÅŸÄ±na Ã§Ä±kma sorununu Ã§Ã¶zer)
        document.addEventListener('mousemove', handleCueSliderMove);
        document.addEventListener('mouseup', handleCueSliderUp);
        document.addEventListener('touchmove', handleCueSliderMove);
        document.addEventListener('touchend', handleCueSliderUp);

        document.getElementById('pauseButton').addEventListener('click', () => showScreen('pause_menu'));

        gameReady = true;
        showScreen('main_menu');
        gameLoop();
    }

    function loadLevel(lvl) {
        const currentLevelData = levels[(lvl - 1) % levels.length];
        if (!currentLevelData) {
            showScreen('game_end'); 
            return;
        }

        level = lvl;
        shotAttempt = 1;
        isBallMoving = false;
        isAiming = true; // Toplar durduÄŸu an niÅŸan alma baÅŸlar
        shotPower = 0;
        
        // UI elemanlarÄ±nÄ± gÃ¶ster
        document.getElementById('englishSelector').style.display = 'block'; 
        document.getElementById('powerBarContainer').style.display = 'block';

        // ToplarÄ± sÄ±fÄ±rla
        balls = [];
        const cueBallData = currentLevelData.white;
        balls.push(new Ball(cueBallData.x, cueBallData.y, CUE_BALL_COLOR, 'cue'));
        balls.push(new Ball(currentLevelData.red.x, currentLevelData.red.y, OBJECT_BALL_COLOR, 'red'));
        balls.push(new Ball(currentLevelData.yellow.x, currentLevelData.yellow.y, OBJECT_BALL_2_COLOR, 'yellow'));
        
        // BaÅŸlangÄ±Ã§ niÅŸan noktasÄ± (Cue Ball'Ä±n Ã¼stÃ¼ne)
        aimTargetPos = { x: cueBallData.x, y: cueBallData.y - 100 }; 
        resetShotTargets();
        cueHandleVisualY = 0; // Ä°steka pozisyonunu sÄ±fÄ±rla
        updateCueHandleVisuals(); // GÃ¶rseli ve gÃ¼Ã§ barÄ±nÄ± sÄ±fÄ±rla
    }

    function resetShotTargets() {
         hitTargets = { red: false, yellow: false, bands: 0 };
    }

    function gameLoop() {
        if (gameReady) {
            update();
            draw();
            checkGameState();
            
            // Toplar durduysa niÅŸan alma aÅŸamasÄ±nÄ± baÅŸlat
            if (!isBallMoving && currentScreen === 'game') {
                isAiming = true;
                document.getElementById('englishSelector').style.display = 'block';
                document.getElementById('powerBarContainer').style.display = 'block';
            } else {
                 isAiming = false;
            }
        }
        requestAnimationFrame(gameLoop);
    }

    function update() {
        if (currentScreen !== 'game') return;

        let allStopped = true;
        balls.forEach(ball => {
            ball.update();
            if (ball.isMoving()) {
                allStopped = false;
            }
        });

        isBallMoving = !allStopped;
        
        if (isBallMoving) {
            // Ã‡arpÄ±ÅŸmalarÄ± kontrol et
            for (let i = 0; i < balls.length; i++) {
                for (let j = i + 1; j < balls.length; j++) {
                    checkBallCollision(balls[i], balls[j]);
                }
            }
        }
    }

    function checkGameState() {
        if (currentScreen !== 'game') return;

        if (!isBallMoving && !isAiming) {
            
            if (hitTargets.red && hitTargets.yellow && hitTargets.bands >= 3) {
                // KAZANÃ‡
                showScreen('level_complete');
            } else {
                // KAYIP/FAUL
                console.log(`Faul! 3 bant gerekiyordu, sadece ${hitTargets.bands} vuruÅŸ yapÄ±ldÄ±. Otomatik level yeniden baÅŸlatÄ±lÄ±yor.`);
                loadLevel(level); // Otomatik yeniden baÅŸlat
            }
            
            resetShotTargets();
            shotPower = 0;
            isAiming = true; // Yeniden niÅŸan almaya baÅŸla
        } 
    }

    function checkBallCollision(b1, b2) {
        const dx = b2.x - b1.x;
        const dy = b2.y - b1.y;
        const distSq = dx * dx + dy * dy;
        const minDist = b1.radius + b2.radius;

        if (distSq <= minDist * minDist) {
            const dist = Math.sqrt(distSq);
            const nx = dx / dist; 
            const ny = dy / dist; 

            const overlap = minDist - dist;
            b1.x -= overlap * 0.5 * nx;
            b1.y -= overlap * 0.5 * ny;
            b2.x += overlap * 0.5 * nx;
            b2.y += overlap * 0.5 * ny;

            const v1n = b1.vx * nx + b1.vy * ny;
            const v2n = b2.vx * nx + b2.vy * ny;

            if (v1n > 0 || v2n < 0) {
                 const newV1n = v2n;
                 const newV2n = v1n;

                 b1.vx += (newV1n - v1n) * nx;
                 b1.vy += (newV1n - v1n) * ny;
                 b2.vx += (newV2n - v2n) * nx;
                 b2.vy += (newV2n - v2n) * ny;

                if (b1.type === 'cue' || b2.type === 'cue') {
                    const otherBall = b1.type === 'cue' ? b2 : b1;
                    if (otherBall.type === 'red') hitTargets.red = true;
                    if (otherBall.type === 'yellow') hitTargets.yellow = true;
                }
            }
        }
    }

    function draw() {
        // Tuvali Temizle
        ctx.fillStyle = '#034827';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

        // DÄ±ÅŸ BantlarÄ± Ã‡iz
        ctx.fillStyle = '#056238';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CUSHION_WIDTH); 
        ctx.fillRect(0, CANVAS_HEIGHT - CUSHION_WIDTH, CANVAS_WIDTH, CUSHION_WIDTH); 
        ctx.fillRect(0, CUSHION_WIDTH, CUSHION_WIDTH, CANVAS_HEIGHT - 2 * CUSHION_WIDTH); 
        ctx.fillRect(CANVAS_WIDTH - CUSHION_WIDTH, CUSHION_WIDTH, CUSHION_WIDTH, CANVAS_HEIGHT - 2 * CUSHION_WIDTH); 

        // ToplarÄ± Ã§iz
        balls.forEach(ball => ball.draw());

        // NiÅŸan alma Ã§izimlerini yap
        if (isAiming) {
            drawAiming();
        }

        // Seviye metni Ã§iz
        ctx.fillStyle = TEXT_COLOR;
        ctx.font = 'bold 24px Inter';
        ctx.textAlign = 'left';
        // Sadece Level bilgisini gÃ¶ster
        ctx.fillText(`Level: ${level}`, 20, 40); 

        // English SeÃ§ici UI Ã§iz
        drawEnglishSelector();
    }

    function drawAiming() {
        const cueBall = balls[0];
        
        // NiÅŸan aÃ§Ä±sÄ± sÃ¼rekli olarak imleÃ§ pozisyonundan hesaplanÄ±r
        const currentAngle = Math.atan2(aimTargetPos.y - cueBall.y, aimTargetPos.x - cueBall.x);

        // --- NoktalÄ± NiÅŸan Ã‡izgisi ---
        ctx.setLineDash([5, 5]);
        ctx.strokeStyle = '#FFF'; 
        ctx.lineWidth = 2;
        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.moveTo(cueBall.x, cueBall.y);
        
        const lineEndX = cueBall.x + Math.cos(currentAngle) * 1000;
        const lineEndY = cueBall.y + Math.sin(currentAngle) * 1000;
        
        ctx.lineTo(lineEndX, lineEndY);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.globalAlpha = 1.0;

        // Ä°steka Ã§ubuÄŸu gÃ¶rsel geri bildirimi
        if (shotPower > 0.1) {
            const cueLength = 100;
            const cueTipGap = BALL_RADIUS + 5; 
            
            // GÃ¼ce gÃ¶re geri Ã§ekilme mesafesi (Bu gÃ¶rsel geri bildirim isteka Ã§ubuÄŸundaki hareketten baÄŸÄ±msÄ±zdÄ±r)
            const powerRatio = shotPower / MAX_SHOT_POWER;
            const pullBackDist = powerRatio * 50; 

            // Ä°steka, atÄ±ÅŸ aÃ§Ä±sÄ±nÄ±n tam tersi yÃ¶nÃ¼ne yerleÅŸtirilir
            const cueStartDist = cueTipGap + pullBackDist; 
            const cueEndDist = cueStartDist + cueLength;

            const cueStartX = cueBall.x - Math.cos(currentAngle) * cueStartDist;
            const cueStartY = cueBall.y - Math.sin(currentAngle) * cueStartDist;
            const cueEndX = cueBall.x - Math.cos(currentAngle) * cueEndDist;
            const cueEndY = cueBall.y - Math.sin(currentAngle) * cueEndDist;

            ctx.strokeStyle = '#8B4513'; // Kahverengi isteka
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(cueStartX, cueStartY);
            ctx.lineTo(cueEndX, cueEndY);
            ctx.stroke();
        }
    }

    function drawEnglishSelector() {
        // English (Falso) SeÃ§iciyi Ã‡iz
        const size = englishCanvas.width;
        const center = size / 2;

        englishCtx.clearRect(0, 0, size, size);
        englishCtx.beginPath();
        englishCtx.arc(center, center, center - 2, 0, Math.PI * 2);
        englishCtx.fillStyle = CUE_BALL_COLOR;
        englishCtx.strokeStyle = '#aaa';
        englishCtx.lineWidth = 2;
        englishCtx.fill();
        englishCtx.stroke();

        const markerX = center + englishX * (center - 5);
        const markerY = center + englishY * (center - 5);

        englishCtx.beginPath();
        englishCtx.arc(markerX, markerY, 5, 0, Math.PI * 2);
        englishCtx.fillStyle = '#000';
        englishCtx.fill();
    }


    // --- GiriÅŸ Ä°ÅŸleyicileri (NiÅŸan AÃ§Ä±sÄ± - Canvas) ---

    function getRelativeCoordinates(e, element) {
        const rect = element.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        
        if (element.id === 'billiardsCanvas') {
            const scaleX = CANVAS_WIDTH / rect.width;
            const scaleY = CANVAS_HEIGHT / rect.height;
            return { x: x * scaleX, y: y * scaleY };
        }
        return { x: x, y: y };
    }

    function handlePointerDown(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming) return;

        // Sadece Canvas'ta niÅŸan alma sÃ¼rÃ¼klemesini baÅŸlat
        if (e.target === canvas || e.target.id === 'billiardsCanvas') {
            isDragging = true;
            aimTargetPos = getRelativeCoordinates(e, canvas);
        }
    }

    function handlePointerMove(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming || !isDragging) return;

        // SÃ¼rÃ¼kleme devam ederken niÅŸan aÃ§Ä±sÄ±nÄ± sÃ¼rekli gÃ¼ncelle
        aimTargetPos = getRelativeCoordinates(e, canvas);
    }

    function handlePointerUp(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming) return;
        
        // Sadece sÃ¼rÃ¼klemeyi bitir, atÄ±ÅŸ yapma gÃ¼ce baÄŸlÄ±
        isDragging = false;
    }
    
    // --- GÃœÃ‡ Ã‡UBUÄžU HAREKET VE HASSASÄ°YET DÃœZELTMELERÄ° (YENÄ° VE DOÄžRU MANTIK) ---
    
    // Ä°steka gÃ¶rselinin pozisyonunu ve gÃ¼Ã§ barÄ±nÄ± gÃ¼nceller
    function updateCueHandleVisuals() {
        // Ä°STEKA GÃ–RSELÄ°NÄ° GÃœNCELLE: cueHandleVisualY, 0 (Ã¼st) ile VISUAL_BAR_HEIGHT (alt) arasÄ±nda deÄŸiÅŸir.
        cueHandle.style.transform = `translateY(${cueHandleVisualY}px)`;
        
        // GÃœÃ‡ BARINI GÃœNCELLE: shotPower'a gÃ¶re doluluk oranÄ±nÄ± ayarla.
        updatePowerBar(shotPower);
    }

    function handleCueSliderDown(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming) return;
        
        // TÄ±klanan elemanÄ±n powerBarContainer olduÄŸundan emin ol (Touch/Mouse)
        if (e.target.closest('#powerBarContainer')) {
            isSliderDragging = true;
            
            const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
            
            // SÃ¼rÃ¼klemenin baÅŸladÄ±ÄŸÄ± ekran Y koordinatÄ±nÄ± kaydet
            dragStartScreenY = clientY; 
            
            // BaÅŸlangÄ±Ã§ta gÃ¶rseli ve gÃ¼cÃ¼ sÄ±fÄ±rla
            cueHandleVisualY = 0; 
            shotPower = 0; 
            updateCueHandleVisuals(); 
        }
    }
    
    // DÃœZELTME #4: Bu fonksiyon artÄ±k document'ten dinleniyor (SÄ±nÄ±rsÄ±z Ã§ekme iÃ§in)
    function handleCueSliderMove(e) {
        if (!isSliderDragging || !isAiming) return;
        e.preventDefault();

        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : dragStartScreenY);
        
        // DÃœZELTME #3: Ters Ã‡ekiÅŸ YÃ¶nÃ¼. AÅŸaÄŸÄ± Ã§ekmek (clientY > dragStartScreenY) gÃ¼cÃ¼ artÄ±rÄ±r.
        const deltaY = clientY - dragStartScreenY; 
        
        // DÃœZELTME #1: Hassasiyet. Ã‡ekme mesafesini SENSITIVITY ile sÄ±nÄ±rla.
        // powerDrag, 0 ile POWER_DRAG_SENSITIVITY (500px) arasÄ±ndadÄ±r.
        const powerDrag = Math.min(Math.max(0, deltaY), POWER_DRAG_SENSITIVITY);

        // GÃ¼Ã§ OranÄ± (0.0 ile 1.0 arasÄ±)
        const powerRatio = powerDrag / POWER_DRAG_SENSITIVITY;
        
        // DÃœZELTME #2: Ä°steka Ã‡ekme OranÄ±nÄ± EÅŸitle (AynÄ± Oran)
        // Ä°stekanÄ±n gÃ¶rsel pozisyonu, GÃ¼Ã§ OranÄ± * GÃ¶rsel YÃ¼kseklik olacak.
        cueHandleVisualY = powerRatio * VISUAL_BAR_HEIGHT; 

        // GÃ¼Ã§ Hesaplama
        shotPower = powerRatio * MAX_SHOT_POWER;

        updateCueHandleVisuals(); 
    }

    // DÃœZELTME #4: Bu fonksiyon artÄ±k document'ten dinleniyor (SÄ±nÄ±rsÄ±z Ã§ekme iÃ§in)
    function handleCueSliderUp(e) {
        if (!isSliderDragging || !isAiming) return;
        isSliderDragging = false;
        
        // AtÄ±ÅŸ bittikten veya iptal edildikten sonra istekayÄ± hemen yukarÄ± Ã§ek (sÄ±fÄ±rla)
        cueHandleVisualY = 0;
        
        if (shotPower > 0.5) { // Minimum gÃ¼Ã§ sÄ±nÄ±rÄ± (0.5 power)
            isAiming = false;
            document.getElementById('powerBarContainer').style.display = 'none';
            document.getElementById('englishSelector').style.display = 'none';
            executeShot();
        } else {
            // Yeterli gÃ¼Ã§ yoksa
            shotPower = 0; 
        }
        updateCueHandleVisuals(); // GÃ¶rseli sÄ±fÄ±rla
    }


    // English Selector Handlers (Falso SeÃ§ici Ä°ÅŸleyicileri)
    let isEnglishDragging = false;
    function handleEnglishDown(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || isBallMoving || !isAiming) return; 
        isEnglishDragging = true;
        handleEnglishMove(e);
    }
    
    function handleEnglishMove(e) {
        e.preventDefault();
        if (currentScreen !== 'game' || !isEnglishDragging) return;
        
        const rect = englishCanvas.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;

        const x = clientX - rect.left - rect.width / 2;
        const y = clientY - rect.top - rect.height / 2;
        const maxDist = rect.width / 2 - 5;
        const dist = Math.hypot(x, y);

        if (dist <= maxDist) {
            englishX = x / maxDist; // -1 ile 1 arasÄ±nda normalize edildi
            englishY = y / maxDist;
        } else {
             // Kenara sabitle
            englishX = x / dist;
            englishY = y / dist;
        }
        drawEnglishSelector();
    }
    
    function handleEnglishUp(e) {
        e.preventDefault();
        isEnglishDragging = false;
    }


    function updatePowerBar(power) {
        const powerLevel = Math.min(power / MAX_SHOT_POWER, 1);
        
        // Dikey Ã§ubuk olduÄŸu iÃ§in yÃ¼ksekliÄŸi ayarla (Alttan yukarÄ± doluyor)
        powerBarFill.style.height = `${powerLevel * 100}%`;

        // GÃ¼ce gÃ¶re renk deÄŸiÅŸtir
        if (powerLevel < 0.33) {
            powerBarFill.style.backgroundColor = '#22c55e'; // YeÅŸil
        } else if (powerLevel < 0.66) {
            powerBarFill.style.backgroundColor = '#facc15'; // SarÄ±
        } else {
            powerBarFill.style.backgroundColor = '#ef4444'; // KÄ±rmÄ±zÄ±
        }
    }

    function executeShot() {
        const cueBall = balls[0];

        // AtÄ±ÅŸ anÄ±ndaki son niÅŸan aÃ§Ä±sÄ±nÄ± hesapla
        shotAngle = Math.atan2(aimTargetPos.y - cueBall.y, aimTargetPos.x - cueBall.x);

        // GÃ¼Ã§ ve isteka Ã§arpanÄ±nÄ± uygula
        const totalPower = shotPower * currentCue.powerMultiplier;

        cueBall.vx = Math.cos(shotAngle) * totalPower;
        cueBall.vy = Math.sin(shotAngle) * totalPower;

        isBallMoving = true;
        shotAttempt++;
    }

    // --- UI/Screen Management (Ekran YÃ¶netimi) ---

    function showScreen(screenId) {
        currentScreen = screenId;
        const container = document.getElementById('screenContainer');
        const pauseButton = document.getElementById('pauseButton');
        container.innerHTML = '';
        container.style.display = 'flex';
        pauseButton.classList.add('hidden');
        document.getElementById('englishSelector').style.display = 'none';
        document.getElementById('powerBarContainer').style.display = 'none';

        switch (screenId) {
            case 'main_menu':
                container.innerHTML = createMainMenu();
                break;
            case 'options':
                container.innerHTML = createOptionsScreen();
                break;
            case 'shop':
                container.innerHTML = createShopScreen();
                break;
            case 'game':
                container.style.display = 'none';
                pauseButton.classList.remove('hidden');
                
                // Oyun devam ederken UI elemanlarÄ±nÄ±n gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol et
                if (!isBallMoving) {
                    document.getElementById('englishSelector').style.display = 'block';
                    document.getElementById('powerBarContainer').style.display = 'block';
                    isAiming = true;
                }
                break;
            case 'pause_menu':
                container.innerHTML = createPauseMenu();
                break;
            case 'level_complete':
                container.innerHTML = createLevelCompleteScreen();
                break;
            case 'game_end':
                container.innerHTML = createGameEndScreen();
                break;
        }
        attachButtonListeners();
    }
    
    function attachButtonListeners() {
        document.querySelectorAll('.js-button').forEach(button => {
            button.addEventListener('click', () => {
                const action = button.getAttribute('data-action');
                handleMenuAction(action);
            });
        });
    }

    function handleMenuAction(action) {
        switch (action) {
            case 'start':
                loadLevel(playerData.currentLevel);
                showScreen('game');
                break;
            case 'options':
                showScreen('options');
                break;
            case 'shop':
                showScreen('shop');
                break;
            case 'continue':
                showScreen('game');
                break;
            case 'main_menu':
                showScreen('main_menu');
                break;
            case 'next_level':
                playerData.currentLevel++;
                saveGameData();
                loadLevel(playerData.currentLevel);
                showScreen('game');
                break;
            case 'toggle_sfx':
                playerData.sfx = !playerData.sfx;
                saveGameData();
                showScreen('options');
                break;
            case 'toggle_music':
                playerData.music = !playerData.music;
                saveGameData();
                showScreen('options');
                break;
        }
    }
    
    function showMessageBox(title, message, onConfirm = null) {
        const container = document.getElementById('screenContainer');
        container.style.display = 'flex';
        container.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm text-center">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <button id="msgBoxOk" class="game-button">ANLADIM</button>
            </div>
        `;
        currentScreen = 'message_box'; 
        
        document.getElementById('msgBoxOk').addEventListener('click', () => {
            if (onConfirm) onConfirm();
            if(currentScreen === 'message_box') showScreen('game'); 
        });
    }

    function createMainMenu() {
        return `
            <div class="p-8 text-center bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
                <h1 class="text-4xl font-extrabold text-yellow-400 mb-8">3-CUSHION CAROM</h1>
                <div class="flex flex-col space-y-4">
                    <button class="game-button js-button" data-action="start">BaÅŸla (Level ${playerData.currentLevel})</button>
                    <button class="game-button js-button" data-action="options">Ayarlar</button>
                    <button class="game-button js-button" data-action="shop">MaÄŸaza</button>
                </div>
            </div>
        `;
    }

    function createPauseMenu() {
        return `
            <div class="p-8 text-center bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
                <h1 class="text-3xl font-bold text-white mb-6">Oyun DuraklatÄ±ldÄ±</h1>
                <div class="flex flex-col space-y-4">
                    <button class="game-button js-button" data-action="continue">Devam Et</button>
                    <button class="game-button js-button" data-action="options">Ayarlar</button>
                    <button class="game-button js-button" data-action="main_menu">Ana MenÃ¼</button>
                </div>
            </div>
        `;
    }

    function calculateCoins() {
        const baseCoins = 100;
        let bonus = 0;
        if (shotAttempt === 1) bonus = 50;
        if (shotAttempt <= 3) bonus = 20;

        const earnedCoins = baseCoins + bonus;
        playerData.coins += earnedCoins;
        saveGameData();
        return earnedCoins;
    }

    function createLevelCompleteScreen() {
        const earned = calculateCoins();
        return `
            <div class="p-8 text-center bg-green-700 rounded-xl shadow-2xl w-full max-w-sm text-white">
                <h1 class="text-4xl font-extrabold mb-4">LEVEL TAMAMLANDI!</h1>
                <p class="text-lg mb-2">Deneme SayÄ±sÄ±: ${shotAttempt}</p>
                <p class="text-2xl font-bold mb-6">KazanÄ±lan Para: <span class="text-yellow-300">${earned}</span></p>
                <p class="text-lg mb-6">Toplam Para: ${playerData.coins}</p>
                <div class="flex flex-col space-y-4">
                    <button class="game-button bg-green-900 js-button" data-action="next_level">Sonraki Level</button>
                    <button class="game-button js-button" data-action="main_menu">Ana MenÃ¼</button>
                </div>
            </div>
        `;
    }
    
    function createGameEndScreen() {
        return `
            <div class="p-8 text-center bg-yellow-500 rounded-xl shadow-2xl w-full max-w-sm text-gray-900">
                <h1 class="text-4xl font-extrabold mb-4">TEBRÄ°KLER!</h1>
                <p class="text-xl mb-6">TÃ¼m mevcut levelleri tamamladÄ±nÄ±z!</p>
                <p class="text-lg mb-6">Toplam Para: ${playerData.coins}</p>
                <div class="flex flex-col space-y-4">
                    <button class="game-button bg-yellow-700 text-white js-button" data-action="shop">MaÄŸazayÄ± Ziyaret Et</button>
                    <button class="game-button bg-gray-700 text-white js-button" data-action="main_menu">Ana MenÃ¼</button>
                </div>
            </div>
        `;
    }

    function createOptionsScreen() {
        const sfxText = playerData.sfx ? 'AÃ‡IK' : 'KAPALI';
        const musicText = playerData.music ? 'AÃ‡IK' : 'KAPALI';

        return `
            <div class="p-8 text-center bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm text-white">
                <h1 class="text-3xl font-bold mb-6">Ayarlar</h1>
                <div class="flex flex-col space-y-4">
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                        <span>Ses Efektleri:</span>
                        <button class="game-button text-sm px-4 py-2 ${playerData.sfx ? 'bg-green-600' : 'bg-red-600'} js-button" data-action="toggle_sfx">${sfxText}</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                        <span>MÃ¼zik:</span>
                        <button class="game-button text-sm px-4 py-2 ${playerData.music ? 'bg-green-600' : 'bg-red-600'} js-button" data-action="toggle_music">${musicText}</button>
                    </div>
                    <button class="game-button bg-gray-500 hover:bg-gray-600 js-button" data-action="main_menu">Geri</button>
                </div>
            </div>
        `;
    }

    function createShopScreen() {
        let shopHtml = `
            <div class="p-8 text-center bg-gray-800 rounded-xl shadow-2xl w-full max-w-md text-white">
                <h1 class="text-3xl font-bold mb-2">MaÄŸaza</h1>
                <p class="text-yellow-400 text-xl mb-6">Para: ${playerData.coins} ðŸ’°</p>
                
                <h2 class="text-2xl font-semibold mt-6 mb-3 border-b border-gray-700 pb-1">Ä°stekalar (GÃ¼Ã§)</h2>
        `;

        // Cues Section
        shopItems.cues.forEach(item => {
            const isOwned = playerData.ownedCues.includes(item.name);
            const isSelected = playerData.selectedCue === item.name;
            const buttonText = isOwned ? (isSelected ? 'KULLANILIYOR' : 'Kullan') : `SatÄ±n Al - ${item.price} ðŸ’°`;
            const buttonColor = isOwned ? (isSelected ? 'bg-green-600' : 'bg-blue-600') : (playerData.coins >= item.price ? 'bg-red-500' : 'bg-gray-600');

            shopHtml += `
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg mb-3">
                    <div class="text-left">
                        <span class="font-bold">${item.name}</span> 
                        <span class="text-sm text-gray-400"> (GÃ¼Ã§ x${item.powerMultiplier.toFixed(1)})</span>
                        <p class="text-xs text-gray-400">${item.description}</p>
                    </div>
                    <button class="game-button text-sm px-4 py-2 ${buttonColor} js-shop-item" data-type="cue" data-name="${item.name}" data-price="${item.price}" data-owned="${isOwned}" data-selected="${isSelected}" ${!isOwned && playerData.coins < item.price ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
            `;
        });
        
        shopHtml += `<h2 class="text-2xl font-semibold mt-6 mb-3 border-b border-gray-700 pb-1">Toplar (Kozmetik)</h2>`;

        // Balls Section
        shopItems.balls.forEach(item => {
            const isOwned = playerData.ownedBalls.includes(item.name);
            const isSelected = playerData.selectedBall === item.name;
            const buttonText = isOwned ? (isSelected ? 'KULLANILIYOR' : 'Kullan') : `SatÄ±n Al - ${item.price} ðŸ’°`;
            const buttonColor = isOwned ? (isSelected ? 'bg-green-600' : 'bg-blue-600') : (playerData.coins >= item.price ? 'bg-red-500' : 'bg-gray-600');

            shopHtml += `
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg mb-3">
                    <div class="text-left">
                        <div class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${item.color}; border: 1px solid #fff;"></div>
                        <span class="font-bold">${item.name}</span> 
                        <p class="text-xs text-gray-400">${item.description}</p>
                    </div>
                    <button class="game-button text-sm px-4 py-2 ${buttonColor} js-shop-item" data-type="ball" data-name="${item.name}" data-price="${item.price}" data-owned="${isOwned}" data-selected="${isSelected}" ${!isOwned && playerData.coins < item.price ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
            `;
        });


        shopHtml += `
                <button class="game-button bg-gray-500 hover:bg-gray-600 mt-6 js-button" data-action="main_menu">Geri</button>
            </div>
        `;

        // Attach shop-specific listeners
        setTimeout(() => {
             document.querySelectorAll('.js-shop-item').forEach(button => {
                button.addEventListener('click', () => {
                    handleShopAction(button);
                });
            });
        }, 0);

        return shopHtml;
    }

    function handleShopAction(button) {
        const type = button.getAttribute('data-type');
        const name = button.getAttribute('data-name');
        const price = parseInt(button.getAttribute('data-price'));
        const isOwned = button.getAttribute('data-owned') === 'true';
        const isSelected = button.getAttribute('data-selected') === 'true';

        if (!isOwned) {
            // Buy item
            if (playerData.coins >= price) {
                playerData.coins -= price;
                if (type === 'cue') playerData.ownedCues.push(name);
                if (type === 'ball') playerData.ownedBalls.push(name);
                showMessageBox("SatÄ±n Alma BaÅŸarÄ±lÄ±!", `${name} envanterinize eklendi.`, () => {
                    // Equip after purchase
                    if (type === 'cue') playerData.selectedCue = name;
                    if (type === 'ball') playerData.selectedBall = name;
                    currentCue = shopItems.cues.find(c => c.name === name) || shopItems.cues[0];
                    saveGameData();
                    showScreen('shop');
                });

            } else {
                 showMessageBox("Yetersiz Para", `SatÄ±n almak iÃ§in ${price - playerData.coins} paraya daha ihtiyacÄ±n var.`);
            }
        } else if (!isSelected) {
            // Equip item
            if (type === 'cue') playerData.selectedCue = name;
            if (type === 'ball') playerData.selectedBall = name;
            currentCue = shopItems.cues.find(c => c.name === name) || shopItems.cues[0];
            saveGameData();
            showScreen('shop');
        }
    }


    // Initialize the game when the window loads
    window.onload = initializeGame;

    console.log("NOTE: This application uses localStorage instead of Firebase for persistence.");
</script>

</body>
</html>
